<section class="playlist-page">
  <header class="hero">
    <div class="hero-text">
      <p class="eyebrow">Biblioteca</p>
      <h1>@if (username()) {<span class="username">{{ username() }}</span> } playlists</h1>
      <p class="hero-desc">Crea tu colección, agrega canciones y escúchalas cuando quieras</p>
    </div>
  </header>

  @if (!isLoggedIn()) {
  <section class="state-card">
    <h2>Inicia sesión para gestionar tus listas</h2>
    <p>Las playlists se guardan y se sincronizan con tu cuenta.</p>
  </section>
  } @else {
  <div class="workspace">
    <aside class="panel">
      <h2>Crear lista</h2>
      <form class="create-form" [formGroup]="createListForm" (ngSubmit)="createPlaylist()">
        <input id="playlistName" type="text" formControlName="name" placeholder="Nombre para tu lista" />

        @if (createListForm.controls.name.invalid && createListForm.controls.name.touched) {
        <span class="field-error">Nombre demasiado corto</span>
        }

        <button type="submit" [disabled]="createListForm.invalid || creatingPlaylist()">
          {{ creatingPlaylist() ? 'Creando...' : 'Crear lista' }}
        </button>
      </form>

      <div class="playlist-summary">
        <h3>Mis listas</h3>
        @for (playlist of playlists(); track playlist.id) {
        <button
          type="button"
          class="playlist-item"
          [class.active]="selectedPlaylist()?.id === playlist.id"
          (click)="openPlaylist(playlist.id)"
        >
          <span class="name">{{ playlist.listName }}</span>
          <span class="meta">{{ playlist.songCount }} canciones</span>
        </button>
        } @empty {
        <p class="empty">Todavía no tienes listas creadas.</p>
        }
      </div>
    </aside>

    <main class="panel detail">
      @if (loadingPlaylist()) {
      <p class="loading">Cargando lista...</p>
      }

      @if (selectedPlaylist(); as playlist) {
      <div class="playlist-header">
        <div>
          <p class="eyebrow">Lista activa</p>
          <h2>{{ playlist.listName }}</h2>
          <span>{{ playlist.songCount }} canciones guardadas</span>
        </div>

        <button class="danger" type="button" (click)="deleteCurrentPlaylist()" [disabled]="deletingPlaylist()">
          {{ deletingPlaylist() ? 'Borrando...' : 'Borrar lista' }}
        </button>
      </div>

      <form class="search-form" [formGroup]="searchForm" (ngSubmit)="searchTracksToAdd()">
        <label for="trackQuery">Busca una canción para añadir</label>
        <div class="search-row">
          <input id="trackQuery" type="text" formControlName="query" placeholder="Artista o canción" />
          <button type="submit" [disabled]="searchForm.invalid || searchingTracks()">
            {{ searchingTracks() ? 'Buscando...' : 'Buscar' }}
          </button>
        </div>
      </form>

      @if (searchResults().length > 0) {
      <section class="results">
        <h3>Resultados</h3>
        @for (track of searchResults(); track track.id) {
        <article class="result-item">
          <img [src]="track.cover" alt="Cover de {{ track.title }}" />
          <div class="track-info">
            <strong>{{ track.title }}</strong>
            <span>{{ track.artist }}</span>
          </div>
          <button type="button" (click)="addTrack(track)" [disabled]="addingTrackId().has(track.id)">
            {{ addingTrackId().has(track.id) ? 'Añadiendo...' : 'Agregar canción' }}
          </button>
        </article>
        }
      </section>
      }

      <section class="songs">
        <h3>Canciones en esta lista</h3>

        @if (playlist.songs.length === 0) {
        <p class="empty">Aún no hay canciones. Usa "Agregar canción" para empezar.</p>
        } @else {
        @for (song of playlist.songs; track song.id) {
        <article class="song-item">
          <img [src]="song.cover" alt="Cover de {{ song.title }}" />
          <div class="song-info">
            <strong>{{ song.title }}</strong>
            <span>{{ song.artist }}</span>
          </div>

          <div class="song-actions">
            <button type="button" (click)="playSong(song)" [disabled]="!song.previewUrl">
              Reproducir
            </button>
            <button
              type="button"
              class="remove"
              (click)="removeTrack(song)"
              [disabled]="removingTrackId().has(song.trackId)"
            >
              {{ removingTrackId().has(song.trackId) ? 'Quitando...' : 'Quitar' }}
            </button>
          </div>
        </article>
        }
        }
      </section>
      } @else {
      <section class="state-card">
        <h2>No hay lista seleccionada</h2>
        <p>Crea una lista nueva o selecciona una de la barra lateral.</p>
      </section>
      }
    </main>
  </div>
  }

  @if (errorMessage()) {
  <p class="feedback error">{{ errorMessage() }}</p>
  }

  @if (successMessage()) {
  <p class="feedback success">{{ successMessage() }}</p>
  }

  @if (confirmDeletePlaylist()) {
  <div class="modal-overlay" (click)="cancelDelete()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="cancelDelete()">&times;</button>
      <h2>Eliminar lista</h2>
      <p class="modal-message">¿Quieres borrar la lista "{{ confirmDeletePlaylist()!.listName }}"? Esta acción no se puede deshacer.</p>
      <div class="modal-actions">
        <button class="modal-cancel" type="button" (click)="cancelDelete()">Cancelar</button>
        <button class="modal-confirm" type="button" (click)="confirmDelete()" [disabled]="deletingPlaylist()">
          {{ deletingPlaylist() ? 'Borrando...' : 'Borrar lista' }}
        </button>
      </div>
    </div>
  </div>
  }
</section>
