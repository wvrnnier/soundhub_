<div class="profile-page">

    <!-- MODO EDICIÓN: FORMULARIO -->
    @if (isEditing) {
    <div class="edit-container">
        <h2>Editar Perfil</h2>

        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="edit-form">

            <div class="form-group">
                <label>Nombre de usuario</label>
                <input type="text" formControlName="username" placeholder="Tu nombre">
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" formControlName="email" placeholder="correo@ejemplo.com">
            </div>



            <div class="form-checkbox">
                <input type="checkbox" id="news" formControlName="newsletter">
                <label for="news">Recibir novedades y ofertas</label>
            </div>

            <div class="form-group">
                <label>Nueva contraseña <span class="optional-label">(opcional)</span></label>
                <input type="password" formControlName="password" placeholder="Dejar vacío para no cambiar">
                @if (profileForm.controls.password.touched && profileForm.controls.password.errors?.['minlength']) {
                    <span class="form-error">Mínimo 8 caracteres</span>
                }
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" (click)="toggleEdit()">Cancelar</button>
                <button type="submit" class="btn-save" [disabled]="profileForm.invalid">Guardar cambios</button>
            </div>

        </form>
    </div>
    }

    <!-- MODO VISUALIZACIÓN: PERFIL NORMAL -->
    @else {
    <div class="profile-header">
        <div class="profile-img-container">
            <img [src]="userView.image" alt="Profile" class="profile-img" />
            <div class="edit-overlay"></div>
        </div>

        <div class="profile-info">
            <span class="label">Perfil</span>
            <h1 class="name">{{ userView.name }}</h1>
            <div class="stats">
                <span>{{ userView.playlists }} listas públicas</span>
            </div>
        </div>

        <!-- Botón que activa la edición -->
        <button class="edit-btn" (click)="toggleEdit()">
            Editar perfil
        </button>
    </div>

    <div class="content">
        <section class="section">
            <div class="section-top">
                <h2>Canciones más escuchadas de este mes</h2>
            </div>
            <div class="track-grid">
                @for (track of topTracks().slice(0, 14); track track.id) {
                <app-track-card [track]="track"></app-track-card>
                }
            </div>
        </section>
    </div>

    <div class="danger-zone">
        <button type="button" class="btn-delete" (click)="deleteUser()">
            Eliminar cuenta
        </button>
    </div>
    }

</div>

<!-- ... (resto del HTML) ... -->

<!-- TEMPLATE DEL DIÁLOGO DE CONFIRMACIÓN -->
<ng-template #deleteDialog>
    <div class="delete-dialog-container">
        <h2 mat-dialog-title>¿Eliminar cuenta?</h2>
        <mat-dialog-content>
            <p>Esta acción es irreversible. Perderás todos tus datos y listas de reproducción.</p>
            <div class="form-group dialog-password">
                <label>Introduce tu contraseña para confirmar</label>
                <input type="password" [formControl]="deletePasswordControl" placeholder="Tu contraseña">
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Cancelar</button>
            <button mat-button [mat-dialog-close]="true" color="warn" class="confirm-delete-btn"
                [disabled]="deletePasswordControl.invalid">
                Eliminar definitivamente
            </button>
        </mat-dialog-actions>
    </div>
</ng-template>